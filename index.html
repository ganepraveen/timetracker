<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Time Tracker Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .message-box {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
            transform: translateX(120%);
            opacity: 0;
            z-index: 1000;
        }
        .message-box.show {
            transform: translateX(0);
            opacity: 1;
        }
        .mobile-layout {
            @media (max-width: 767px) {
                flex-direction: column;
                gap: 1.5rem;
            }
        }
        .section-container {
            @media (max-width: 767px) {
                width: 100%;
            }
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <!-- Main Dashboard Container -->
    <div class="w-full max-w-4xl bg-white p-6 md:p-10 rounded-xl shadow-lg flex flex-col md:flex-row gap-8 mobile-layout">
        <!-- Main Info Section (Left) -->
        <div class="md:w-1/2 w-full flex flex-col gap-6 section-container">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800">Time Tracker Dashboard</h1>
            <p class="text-gray-500 mt-2">Effortlessly track your work hours to stay within your 20-hour weekly limit. Your data is automatically saved and updated in real-time.</p>
            <p class="text-xs text-gray-400 mt-4">User ID: <span id="userIdDisplay" class="font-mono text-gray-500 break-all">...loading...</span></p>

            <!-- Key Metrics Card -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-6">
                <!-- Weekly Total Card -->
                <div class="bg-blue-100 p-6 rounded-lg shadow-sm">
                    <p class="text-lg font-medium text-blue-700">This Week's Total</p>
                    <p id="weeklyTotal" class="text-4xl font-bold text-blue-900 mt-2">0.00</p>
                    <p class="text-sm text-blue-600">Hours <span id="weeklyDateRange" class="font-normal text-xs ml-1">(...loading...)</span></p>
                </div>

                <!-- Hours Remaining Card -->
                <div class="bg-green-100 p-6 rounded-lg shadow-sm">
                    <p class="text-lg font-medium text-green-700">Hours Remaining</p>
                    <p id="hoursRemaining" class="text-4xl font-bold text-green-900 mt-2">20.00</p>
                    <p class="text-sm text-green-600">Hours</p>
                </div>
            </div>

            <div class="mt-4 text-center text-gray-500">
                <p id="todayDate" class="font-medium text-sm"></p>
            </div>

            <!-- Real-time Tracker Buttons -->
            <div class="mt-6 bg-gray-50 p-6 rounded-lg shadow-sm text-center">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Clock In/Out</h2>
                <div class="flex flex-col gap-4">
                    <button id="clockInBtn" class="w-full bg-blue-600 text-white py-4 rounded-md text-lg font-semibold hover:bg-blue-700 transition duration-300 shadow-md">
                        Clock In
                    </button>
                    <button id="clockOutBtn" class="w-full bg-blue-400 text-white py-4 rounded-md text-lg font-semibold hover:bg-blue-500 transition duration-300 shadow-md" disabled>
                        Clock Out
                    </button>
                </div>
            </div>
        </div>

        <!-- Time Log Section (Right) -->
        <div class="md:w-1/2 w-full flex flex-col section-container">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800">Your Time Log</h2>
            <div id="entriesList" class="mt-4 space-y-4 max-h-[500px] overflow-y-auto">
                <!-- Entries will be dynamically added here -->
                <p class="text-gray-500 text-center py-8">No entries found. Clock in to get started.</p>
            </div>
        </div>
    </div>

    <!-- Custom Message Box -->
    <div id="messageBox" class="message-box bg-white text-gray-800"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, deleteDoc, onSnapshot, collection, addDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set Firebase logging level to debug
        setLogLevel('Debug');
        
        // --- IMPORTANT: REPLACE WITH YOUR FIREBASE CONFIGURATION ---
        // Get this from your Firebase project settings in the console.
        const firebaseConfig = {
			  apiKey: "AIzaSyAWCdyc1ICphxVin-Ps9-ecU3_kKJFUKHs",
			  authDomain: "time-tracker-da677.firebaseapp.com",
			  projectId: "time-tracker-da677",
			  storageBucket: "time-tracker-da677.firebasestorage.app",
			  messagingSenderId: "759776821855",
			  appId: "1:759776821855:web:540422c3118dde613851ea",
			  measurementId: "G-FZPX1GPGL8"
			};
        const appId = firebaseConfig.appId;
        // -------------------------------------------------------------
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        const WEEKLY_LIMIT_HOURS = 20;
        let userId = null;
        let allEntries = {}; // Store all entries from Firestore

        const userIdDisplay = document.getElementById('userIdDisplay');
        const weeklyTotalDisplay = document.getElementById('weeklyTotal');
        const hoursRemainingDisplay = document.getElementById('hoursRemaining');
        const entriesList = document.getElementById('entriesList');
        const messageBox = document.getElementById('messageBox');
        const weeklyDateRangeDisplay = document.getElementById('weeklyDateRange');
        const todayDateDisplay = document.getElementById('todayDate');
        const clockInBtn = document.getElementById('clockInBtn');
        const clockOutBtn = document.getElementById('clockOutBtn');

        function showMessage(message, type = 'success') {
            messageBox.textContent = message;
            messageBox.className = `message-box show ${type === 'success' ? 'bg-green-200 text-green-800' : 'bg-red-200 text-red-800'}`;
            setTimeout(() => {
                messageBox.classList.remove('show');
            }, 3000);
        }

        // Gets the date of the most recent Wednesday, including the current day.
        function getWeeklyStartDate(currentDate) {
            const date = new Date(currentDate);
            const dayOfWeek = date.getDay(); // Sunday - 0, Monday - 1, ..., Wednesday - 3
            const diff = (dayOfWeek < 3) ? (dayOfWeek + 7 - 3) : (dayOfWeek - 3);
            date.setDate(date.getDate() - diff);
            date.setHours(0, 0, 0, 0);
            return date;
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                userIdDisplay.textContent = userId;
                
                const today = new Date();
                todayDateDisplay.textContent = today.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

                const userTimeEntriesRef = collection(db, `artifacts/${appId}/users/${userId}/time_entries`);

                onSnapshot(userTimeEntriesRef, (snapshot) => {
                    const weeklyStartDate = getWeeklyStartDate(new Date());
                    const weeklyEndDate = new Date(weeklyStartDate);
                    weeklyEndDate.setDate(weeklyEndDate.getDate() + 6);
                    weeklyEndDate.setHours(23, 59, 59, 999);

                    const startDateString = weeklyStartDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    const endDateString = weeklyEndDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    weeklyDateRangeDisplay.textContent = `${startDateString} - ${endDateString}`;
                    
                    allEntries = {};
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        const entryDate = new Date(data.timestamp.toDate()).toLocaleDateString('en-US');
                        if (!allEntries[entryDate]) {
                            allEntries[entryDate] = [];
                        }
                        allEntries[entryDate].push({ id: doc.id, ...data });
                    });

                    let totalWeeklyHours = 0;
                    const sortedDates = Object.keys(allEntries).sort((a, b) => new Date(b) - new Date(a));
                    
                    const renderedEntries = [];
                    sortedDates.forEach(date => {
                        const dayEntries = allEntries[date].sort((a, b) => a.timestamp.toDate() - b.timestamp.toDate());
                        
                        let totalDailyHours = 0;
                        let lastClockIn = null;
                        let lastStatus = null;
                        
                        dayEntries.forEach(entry => {
                            if (lastStatus === null) {
                                // First entry of the day
                                lastStatus = entry.type;
                                if (entry.type === 'clock-in') {
                                    lastClockIn = entry.timestamp.toDate();
                                }
                            } else if (lastStatus === 'clock-in' && entry.type === 'clock-out') {
                                // A valid work period
                                const clockOutTime = entry.timestamp.toDate();
                                const diffInMilliseconds = clockOutTime - lastClockIn;
                                totalDailyHours += diffInMilliseconds / (1000 * 60 * 60);
                                lastStatus = 'clock-out';
                            } else if (lastStatus === 'clock-out' && entry.type === 'clock-in') {
                                // Another shift started
                                lastClockIn = entry.timestamp.toDate();
                                lastStatus = 'clock-in';
                            }
                        });

                        const entryDate = new Date(date);
                        if (entryDate >= weeklyStartDate && entryDate <= weeklyEndDate) {
                            totalWeeklyHours += totalDailyHours;
                        }

                        renderedEntries.push({ date, totalDailyHours, entries: dayEntries });
                    });
                    
                    // Update UI with calculated values
                    weeklyTotalDisplay.textContent = totalWeeklyHours.toFixed(2);
                    const hoursRemaining = WEEKLY_LIMIT_HOURS - totalWeeklyHours;
                    hoursRemainingDisplay.textContent = hoursRemaining.toFixed(2);
                    if (hoursRemaining < 0) {
                        hoursRemainingDisplay.classList.remove('text-green-900');
                        hoursRemainingDisplay.classList.add('text-red-900');
                    } else {
                        hoursRemainingDisplay.classList.remove('text-red-900');
                        hoursRemainingDisplay.classList.add('text-green-900');
                    }
                    
                    renderEntries(renderedEntries);
                });

                // Check for last entry to set button state
                const dailyEntriesRef = collection(db, `artifacts/${appId}/users/${userId}/time_entries`);
                onSnapshot(dailyEntriesRef, (snapshot) => {
                    const sortedEntries = snapshot.docs
                        .map(doc => ({ id: doc.id, ...doc.data() }))
                        .sort((a, b) => b.timestamp.toDate() - a.timestamp.toDate());
                    
                    const lastEntry = sortedEntries[0];
                    if (lastEntry && lastEntry.type === 'clock-in') {
                        clockInBtn.disabled = true;
                        clockOutBtn.disabled = false;
                        clockInBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                        clockInBtn.classList.add('bg-blue-400');
                        clockOutBtn.classList.remove('bg-blue-400', 'hover:bg-blue-500');
                        clockOutBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                    } else {
                        clockInBtn.disabled = false;
                        clockOutBtn.disabled = true;
                        clockInBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                        clockInBtn.classList.remove('bg-blue-400');
                        clockOutBtn.classList.add('bg-blue-400');
                        clockOutBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    }
                });

            } else {
                try {
                    await signInAnonymously(auth);
                } catch (error) {
                    console.error("Error signing in anonymously:", error);
                    showMessage("Authentication failed. Please try again.", "error");
                }
            }
        });

        function renderEntries(dailyEntries) {
            entriesList.innerHTML = ''; // Clear the list
            if (dailyEntries.length === 0) {
                entriesList.innerHTML = `<p class="text-gray-500 text-center py-8">No entries found. Clock in to get started.</p>`;
                return;
            }

            dailyEntries.forEach(dayEntry => {
                const dateHeader = document.createElement('h3');
                dateHeader.className = "text-md font-semibold text-gray-700 mt-4 mb-2 border-b pb-2";
                dateHeader.textContent = new Date(dayEntry.date).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                entriesList.appendChild(dateHeader);

                const totalHoursElement = document.createElement('div');
                totalHoursElement.className = "flex justify-between items-center text-sm font-medium text-gray-600 mb-2";
                totalHoursElement.innerHTML = `<span>Total Hours:</span> <span class="font-bold text-gray-800">${dayEntry.totalDailyHours.toFixed(2)}</span>`;
                entriesList.appendChild(totalHoursElement);

                dayEntry.entries.forEach(entry => {
                    const entryElement = document.createElement('div');
                    entryElement.className = "bg-gray-100 p-3 rounded-md flex justify-between items-center text-sm";
                    
                    const time = entry.timestamp.toDate().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
                    const typeText = entry.type === 'clock-in' ? 'Clocked In' : 'Clocked Out';
                    const typeColor = entry.type === 'clock-in' ? 'text-green-600' : 'text-red-600';

                    entryElement.innerHTML = `
                        <div>
                            <span class="font-medium ${typeColor}">${typeText}</span>
                            <span class="text-gray-500 ml-2">${time}</span>
                        </div>
                        <button class="delete-btn bg-red-500 text-white p-2 rounded-full hover:bg-red-600 transition duration-300" data-id="${entry.id}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                              <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 11-2 0v6a1 1 0 112 0V8z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    `;
                    entriesList.appendChild(entryElement);
                });
            });

            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const docId = e.currentTarget.dataset.id;
                    try {
                        await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/time_entries`, docId));
                        showMessage("Entry deleted successfully.");
                    } catch (error) {
                        console.error("Error deleting document:", error);
                        showMessage("Error deleting entry.", "error");
                    }
                });
            });
        }

        // Handle button clicks
        clockInBtn.addEventListener('click', async () => {
            try {
                const userTimeEntriesRef = collection(db, `artifacts/${appId}/users/${userId}/time_entries`);
                await addDoc(userTimeEntriesRef, {
                    type: 'clock-in',
                    timestamp: new Date(),
                });
                showMessage("Clocked in successfully!");
            } catch (error) {
                console.error("Error adding document:", error);
                showMessage("Error clocking in.", "error");
            }
        });

        clockOutBtn.addEventListener('click', async () => {
            try {
                const userTimeEntriesRef = collection(db, `artifacts/${appId}/users/${userId}/time_entries`);
                await addDoc(userTimeEntriesRef, {
                    type: 'clock-out',
                    timestamp: new Date(),
                });
                showMessage("Clocked out successfully!");
            } catch (error) {
                console.error("Error adding document:", error);
                showMessage("Error clocking out.", "error");
            }
        });
        
    </script>
</body>
</html>
